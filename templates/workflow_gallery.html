{% extends "base.html" %}

{% block title %}AI Image Gallery - Flask App{% endblock %}

{% block content %}
<div class="header">
    <h1>ğŸ–¼ï¸ AI Image Gallery</h1>
    <a href="/" class="btn btn-primary">ğŸ  Back to Dashboard</a>
</div>

<div class="nav-tabs">
    <button class="nav-tab active" onclick="showGalleryTab('top')">â­ Top Notch</button>
    <button class="nav-tab" onclick="showGalleryTab('mids')">ğŸ‘ Mids</button>
    <button class="nav-tab" onclick="showGalleryTab('meh')">ğŸ˜ Meh</button>
    <button class="nav-tab" onclick="showGalleryTab('upscaled')">ğŸ” Upscaled</button>
</div>

{% for category, images in gallery.items() %}
<div id="gallery-{{ category }}" class="tab-content {% if category == 'top' %}active{% endif %}">
    <div class="system-info">
        <h3>
            {% if category == 'top' %}â­ Top Notch Images (Rating 8-10)
            {% elif category == 'mids' %}ğŸ‘ Mid-tier Images (Rating 6-7)
            {% elif category == 'meh' %}ğŸ˜ Lower Rated Images (Rating 1-5)
            {% elif category == 'upscaled' %}ğŸ” Upscaled Images
            {% endif %}
        </h3>
        <p>{{ images|length }} image(s) in this category</p>
    </div>

    {% if images %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            {% for image in images %}
            <div class="item" style="text-align: center;">
                <img src="{{ image.url }}" alt="{{ image.filename }}" 
                     style="width: 100%; max-width: 300px; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; cursor: pointer;"
                     onclick="openImageModal('{{ image.url }}', '{{ image.filename }}', '{{ image.path }}')">
                
                <div class="item-content">
                    <strong>{{ image.filename }}</strong>
                </div>
                
                <div class="item-meta" style="justify-content: center; gap: 10px;">
                    {% if category != 'upscaled' %}
                        <button class="btn btn-primary" onclick="upscaleImage('{{ image.path }}', 2)" 
                                style="font-size: 0.8rem; padding: 5px 10px;">
                            ğŸ” Upscale 2x
                        </button>
                    {% endif %}
                    <button class="btn btn-danger" onclick="deleteImage('{{ image.path }}')" 
                            style="font-size: 0.8rem; padding: 5px 10px;">
                        ğŸ—‘ï¸ Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="item">
            <div class="item-content">
                No images in this category yet. 
                {% if category != 'upscaled' %}
                    Generate some images to get started!
                {% else %}
                    Upscale some images from other categories to see them here.
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endfor %}

<!-- Image Modal -->
<div id="imageModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);" onclick="closeImageModal()">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
        <img id="modalImage" style="width: 100%; height: auto; border-radius: 10px;">
        <div style="text-align: center; color: white; margin-top: 10px;">
            <h3 id="modalTitle"></h3>
            <button onclick="closeImageModal()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 10px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>
</div>

<div class="footer">
    <p>ğŸ¨ Your AI-generated image collection</p>
</div>

<script>
    function showGalleryTab(category) {
        // Hide all gallery tabs
        document.querySelectorAll('[id^="gallery-"]').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected gallery tab
        document.getElementById('gallery-' + category).classList.add('active');
        
        // Add active class to clicked nav tab
        event.target.classList.add('active');
    }

    function openImageModal(imageUrl, filename, imagePath) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('modalTitle').textContent = filename;
        document.getElementById('imageModal').style.display = 'block';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    function upscaleImage(imagePath, scaleFactor) {
        if (!confirm('Upscale this image? This may take a few moments.')) {
            return;
        }

        const formData = new FormData();
        formData.append('image_path', imagePath);
        formData.append('scale_factor', scaleFactor);

        fetch('/workflow/upscale', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Image upscaled successfully! Check the Upscaled tab.');
                location.reload();
            } else {
                alert('Error upscaling image: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to upscale image');
        });
    }

    function deleteImage(imagePath) {
        if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
            return;
        }

        const formData = new FormData();
        formData.append('image_path', imagePath);

        fetch('/workflow/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Image deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting image: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete image');
        });
    }

    // Close modal when clicking outside the image
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImageModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    });
</script>
{% endblock %}