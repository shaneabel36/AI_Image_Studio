{% extends "base.html" %}

{% block title %}AI Image Editor - Flask App{% endblock %}

{% block content %}
<div class="header">
    <h1>âœï¸ AI Image Editor</h1>
    <a href="/" class="btn btn-primary">ğŸ  Back to Dashboard</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div style="padding: 15px; margin: 20px 0; border-radius: 10px; 
                        background: {% if category == 'error' %}#fed7d7{% else %}#c6f6d5{% endif %}; 
                        color: {% if category == 'error' %}#c53030{% else %}#2f855a{% endif %};">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="nav-tabs">
    <button class="nav-tab active" onclick="showEditorTab('select')">ğŸ“ Select Image</button>
    <button class="nav-tab" onclick="showEditorTab('inpaint')">ğŸ¨ Inpainting</button>
    <button class="nav-tab" onclick="showEditorTab('transform')">ğŸ”„ Transform</button>
    <button class="nav-tab" onclick="showEditorTab('background')">ğŸ—‘ï¸ Remove BG</button>
</div>

<!-- Select Image Tab -->
<div id="editor-select" class="tab-content active">
    <div class="system-info">
        <h3>ğŸ“ Choose Image to Edit</h3>
        <p>Select an existing image or upload a new one to start editing</p>
    </div>

    <div class="form-group">
        <label for="imageUpload">ğŸ“¤ Upload New Image:</label>
        <input type="file" id="imageUpload" accept="image/*" class="form-control" onchange="uploadImage()">
    </div>

    {% if images %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
            {% for image in images %}
            <div class="item" style="text-align: center; cursor: pointer;" onclick="selectImage('{{ image.path }}', '{{ image.url }}', '{{ image.filename }}')">
                <img src="{{ image.url }}" alt="{{ image.filename }}" 
                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;">
                <div class="item-content">
                    <strong>{{ image.filename }}</strong>
                    <br><small style="color: #718096;">{{ image.category }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="item">
            <div class="item-content">
                No images available. Generate some images first or upload your own!
            </div>
        </div>
    {% endif %}
</div>

<!-- Inpainting Tab -->
<div id="editor-inpaint" class="tab-content">
    <div class="system-info">
        <h3>ğŸ¨ AI Inpainting</h3>
        <p>Draw on the image to select areas you want to edit, then describe what you want to replace them with.</p>
    </div>

    <div id="selectedImageInfo" style="display: none;">
        <div class="form-group">
            <label>Selected Image:</label>
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                <img id="selectedImageThumb" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px;">
                <div>
                    <strong id="selectedImageName"></strong>
                    <br><button onclick="clearSelection()" class="btn" style="background: #e2e8f0; color: #4a5568; font-size: 0.8rem; padding: 5px 10px; margin-top: 5px;">Change Image</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="inpaintPrompt">ğŸ¯ Inpainting Prompt:</label>
            <textarea id="inpaintPrompt" class="form-control" rows="3" 
                      placeholder="Describe what you want to replace the selected areas with (e.g., 'a beautiful sunset', 'green grass', 'modern furniture')"></textarea>
        </div>

        <div class="form-group">
            <label>ğŸ–Œï¸ Drawing Tools:</label>
            <div style="display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;">
                <button id="brushTool" class="btn btn-primary" onclick="setTool('brush')">ğŸ–Œï¸ Brush</button>
                <button id="eraseTool" class="btn" onclick="setTool('erase')" style="background: #e2e8f0; color: #4a5568;">ğŸ§½ Erase</button>
                <button class="btn" onclick="clearMask()" style="background: #fed7d7; color: #c53030;">ğŸ—‘ï¸ Clear All</button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; margin: 10px 0;">
                <label>Brush Size:</label>
                <input type="range" id="brushSize" min="5" max="50" value="20" onchange="updateBrushSize()">
                <span id="brushSizeValue">20px</span>
            </div>
        </div>

        <div class="form-group">
            <canvas id="drawingCanvas" style="border: 2px solid #e2e8f0; border-radius: 10px; max-width: 100%; cursor: crosshair; display: none;"></canvas>
        </div>

        <div class="form-group">
            <button onclick="performInpainting()" class="btn btn-primary" id="inpaintBtn">ğŸ¨ Start Inpainting</button>
        </div>
    </div>

    <div id="noImageSelected" class="item">
        <div class="item-content">
            Please select an image from the "Select Image" tab first.
        </div>
    </div>
</div>

<!-- Transform Tab -->
<div id="editor-transform" class="tab-content">
    <div class="system-info">
        <h3>ğŸ”„ Image Transformation</h3>
        <p>Transform your image with AI while maintaining the overall composition.</p>
    </div>

    <div id="transformImageInfo" style="display: none;">
        <div class="form-group">
            <label>Selected Image:</label>
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                <img id="transformImageThumb" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px;">
                <div>
                    <strong id="transformImageName"></strong>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="transformPrompt">ğŸ¯ Transformation Prompt:</label>
            <textarea id="transformPrompt" class="form-control" rows="3" 
                      placeholder="Describe how you want to transform the image (e.g., 'make it look like a painting', 'change to winter scene', 'add dramatic lighting')"></textarea>
        </div>

        <div class="form-group">
            <label for="transformStrength">ğŸ’ª Transformation Strength:</label>
            <input type="range" id="transformStrength" min="0.1" max="1.0" step="0.1" value="0.7" onchange="updateStrengthValue()">
            <span id="strengthValue">0.7</span>
            <small style="color: #718096; display: block; margin-top: 5px;">
                Lower values preserve more of the original image, higher values allow more dramatic changes.
            </small>
        </div>

        <div class="form-group">
            <button onclick="performTransformation()" class="btn btn-primary" id="transformBtn">ğŸ”„ Transform Image</button>
        </div>
    </div>

    <div id="noImageSelectedTransform" class="item">
        <div class="item-content">
            Please select an image from the "Select Image" tab first.
        </div>
    </div>
</div>

<!-- Remove Background Tab -->
<div id="editor-background" class="tab-content">
    <div class="system-info">
        <h3>ğŸ—‘ï¸ Background Removal</h3>
        <p>Automatically remove the background from your image using AI.</p>
    </div>

    <div id="backgroundImageInfo" style="display: none;">
        <div class="form-group">
            <label>Selected Image:</label>
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                <img id="backgroundImageThumb" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px;">
                <div>
                    <strong id="backgroundImageName"></strong>
                </div>
            </div>
        </div>

        <div class="form-group">
            <button onclick="removeBackground()" class="btn btn-primary" id="removeBgBtn">ğŸ—‘ï¸ Remove Background</button>
        </div>
    </div>

    <div id="noImageSelectedBackground" class="item">
        <div class="item-content">
            Please select an image from the "Select Image" tab first.
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsSection" style="display: none; margin-top: 30px;">
    <div class="system-info">
        <h3>âœ¨ Results</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div style="text-align: center;">
                <h4>Original</h4>
                <img id="originalResult" style="width: 100%; max-width: 300px; border-radius: 10px;">
            </div>
            <div style="text-align: center;">
                <h4>Edited</h4>
                <img id="editedResult" style="width: 100%; max-width: 300px; border-radius: 10px;">
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="downloadResult()" class="btn btn-primary">ğŸ’¾ Download Result</button>
            <button onclick="hideResults()" class="btn" style="background: #e2e8f0; color: #4a5568; margin-left: 10px;">Close</button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; color: white; text-align: center; padding-top: 20%;">
    <div style="font-size: 2rem; margin-bottom: 20px;">â³</div>
    <h2 id="loadingMessage">Processing your image...</h2>
    <p>This may take a few moments. Please wait.</p>
</div>

<div class="footer">
    <p>âœï¸ Powerful AI image editing at your fingertips</p>
</div>

<script>
    let selectedImagePath = null;
    let selectedImageUrl = null;
    let selectedImageName = null;
    let canvas = null;
    let ctx = null;
    let isDrawing = false;
    let currentTool = 'brush';
    let brushSize = 20;
    let maskData = [];
    let currentStroke = null;

    function showEditorTab(tab) {
        // Hide all tabs
        document.querySelectorAll('[id^="editor-"]').forEach(el => {
            el.classList.remove('active');
        });
        
        // Remove active class from nav tabs
        document.querySelectorAll('.nav-tab').forEach(el => {
            el.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById('editor-' + tab).classList.add('active');
        event.target.classList.add('active');
        
        // Update image info visibility
        updateImageInfoVisibility();
    }

    function selectImage(path, url, name) {
        selectedImagePath = path;
        selectedImageUrl = url;
        selectedImageName = name;
        
        updateImageInfoVisibility();
        setupCanvas();
    }

    function updateImageInfoVisibility() {
        const hasImage = selectedImagePath !== null;
        
        // Update all image info sections
        document.getElementById('selectedImageInfo').style.display = hasImage ? 'block' : 'none';
        document.getElementById('noImageSelected').style.display = hasImage ? 'none' : 'block';
        
        document.getElementById('transformImageInfo').style.display = hasImage ? 'block' : 'none';
        document.getElementById('noImageSelectedTransform').style.display = hasImage ? 'none' : 'block';
        
        document.getElementById('backgroundImageInfo').style.display = hasImage ? 'block' : 'none';
        document.getElementById('noImageSelectedBackground').style.display = hasImage ? 'none' : 'block';
        
        if (hasImage) {
            // Update thumbnails and names
            document.getElementById('selectedImageThumb').src = selectedImageUrl;
            document.getElementById('selectedImageName').textContent = selectedImageName;
            
            document.getElementById('transformImageThumb').src = selectedImageUrl;
            document.getElementById('transformImageName').textContent = selectedImageName;
            
            document.getElementById('backgroundImageThumb').src = selectedImageUrl;
            document.getElementById('backgroundImageName').textContent = selectedImageName;
        }
    }

    function clearSelection() {
        selectedImagePath = null;
        selectedImageUrl = null;
        selectedImageName = null;
        updateImageInfoVisibility();
        showEditorTab('select');
    }

    function setupCanvas() {
        if (!selectedImageUrl) return;
        
        canvas = document.getElementById('drawingCanvas');
        ctx = canvas.getContext('2d');
        
        const img = new Image();
        img.onload = function() {
            // Set canvas size to match image aspect ratio
            const maxWidth = 600;
            const maxHeight = 400;
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            canvas.style.display = 'block';
            
            // Draw the image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Setup drawing events
            setupDrawingEvents();
        };
        img.src = selectedImageUrl;
    }

    function setupDrawingEvents() {
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);
    }

    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        if (e.type === 'touchstart') {
            startDrawing({offsetX: x, offsetY: y});
        } else if (e.type === 'touchmove') {
            draw({offsetX: x, offsetY: y});
        }
    }

    function startDrawing(e) {
        isDrawing = true;
        currentStroke = {
            type: currentTool,
            size: brushSize,
            points: []
        };
        
        const point = {
            x: e.offsetX / canvas.width,
            y: e.offsetY / canvas.height
        };
        currentStroke.points.push(point);
        
        if (currentTool === 'brush') {
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        } else {
            ctx.globalCompositeOperation = 'destination-out';
        }
        
        ctx.beginPath();
        ctx.arc(e.offsetX, e.offsetY, brushSize / 2, 0, 2 * Math.PI);
        ctx.fill();
    }

    function draw(e) {
        if (!isDrawing) return;
        
        const point = {
            x: e.offsetX / canvas.width,
            y: e.offsetY / canvas.height
        };
        currentStroke.points.push(point);
        
        ctx.beginPath();
        ctx.arc(e.offsetX, e.offsetY, brushSize / 2, 0, 2 * Math.PI);
        ctx.fill();
    }

    function stopDrawing() {
        if (isDrawing && currentStroke && currentStroke.points.length > 0) {
            if (currentTool === 'brush') {
                maskData.push(currentStroke);
            }
        }
        isDrawing = false;
        currentStroke = null;
    }

    function setTool(tool) {
        currentTool = tool;
        
        // Update button styles
        document.getElementById('brushTool').className = tool === 'brush' ? 'btn btn-primary' : 'btn';
        document.getElementById('brushTool').style.background = tool === 'brush' ? '' : '#e2e8f0';
        document.getElementById('brushTool').style.color = tool === 'brush' ? '' : '#4a5568';
        
        document.getElementById('eraseTool').className = tool === 'erase' ? 'btn btn-primary' : 'btn';
        document.getElementById('eraseTool').style.background = tool === 'erase' ? '' : '#e2e8f0';
        document.getElementById('eraseTool').style.color = tool === 'erase' ? '' : '#4a5568';
        
        // Update cursor
        canvas.style.cursor = tool === 'brush' ? 'crosshair' : 'grab';
    }

    function updateBrushSize() {
        brushSize = parseInt(document.getElementById('brushSize').value);
        document.getElementById('brushSizeValue').textContent = brushSize + 'px';
    }

    function clearMask() {
        if (canvas && ctx) {
            // Redraw original image
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = selectedImageUrl;
        }
        maskData = [];
    }

    function uploadImage() {
        const fileInput = document.getElementById('imageUpload');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('image', file);
        
        showLoading('Uploading image...');
        
        fetch('/editor/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                selectImage(data.path, data.url, data.filename);
                alert('Image uploaded successfully!');
                location.reload(); // Refresh to show new image in list
            } else {
                alert('Upload failed: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Upload failed');
        });
    }

    function performInpainting() {
        if (!selectedImagePath) {
            alert('Please select an image first');
            return;
        }
        
        const prompt = document.getElementById('inpaintPrompt').value.trim();
        if (!prompt) {
            alert('Please enter a prompt describing what you want to replace the selected areas with');
            return;
        }
        
        if (maskData.length === 0) {
            alert('Please draw on the image to select areas to edit');
            return;
        }
        
        showLoading('Performing inpainting...');
        
        fetch('/editor/inpaint', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_path: selectedImagePath,
                mask_data: maskData,
                prompt: prompt
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showResults(selectedImageUrl, data.result_url);
            } else {
                alert('Inpainting failed: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Inpainting failed');
        });
    }

    function performTransformation() {
        if (!selectedImagePath) {
            alert('Please select an image first');
            return;
        }
        
        const prompt = document.getElementById('transformPrompt').value.trim();
        if (!prompt) {
            alert('Please enter a transformation prompt');
            return;
        }
        
        const strength = parseFloat(document.getElementById('transformStrength').value);
        
        showLoading('Transforming image...');
        
        fetch('/editor/img2img', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_path: selectedImagePath,
                prompt: prompt,
                strength: strength
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showResults(selectedImageUrl, data.result_url);
            } else {
                alert('Transformation failed: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Transformation failed');
        });
    }

    function removeBackground() {
        if (!selectedImagePath) {
            alert('Please select an image first');
            return;
        }
        
        showLoading('Removing background...');
        
        fetch('/editor/remove_bg', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_path: selectedImagePath
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showResults(selectedImageUrl, data.result_url);
            } else {
                alert('Background removal failed: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Background removal failed');
        });
    }

    function updateStrengthValue() {
        const strength = document.getElementById('transformStrength').value;
        document.getElementById('strengthValue').textContent = strength;
    }

    function showResults(originalUrl, resultUrl) {
        document.getElementById('originalResult').src = originalUrl;
        document.getElementById('editedResult').src = resultUrl;
        document.getElementById('resultsSection').style.display = 'block';
        
        // Scroll to results
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    function hideResults() {
        document.getElementById('resultsSection').style.display = 'none';
    }

    function downloadResult() {
        const resultImg = document.getElementById('editedResult');
        const link = document.createElement('a');
        link.download = 'edited_image.png';
        link.href = resultImg.src;
        link.click();
    }

    function showLoading(message) {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    // Initialize
    updateImageInfoVisibility();
</script>
{% endblock %}